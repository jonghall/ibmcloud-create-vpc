- vpc: wtvpc
  region: us-south
  classic_access: false
  generation: 1
  resource_group: vpc_sandbox
  default_network_acl: wtvpc-default-acl
  instanceTemplates:
    - template: webapp_server
      image: ubuntu-16.04-amd64
      profile_name: cc1-2x4
      sshkey: jonhall
      cloud-init-file: cloud-init-webapp.txt
    - template: db_server
      image: ubuntu-16.04-amd64
      profile_name: cc1-2x4
      sshkey: jonhall
      cloud-init-file: cloud-init-db.txt
      volumes:
        - capacity: 100
          profile: general-purpose
          delete_volume_on_instance_delete: true
  zones:
    - name: us-south-1
      address_prefix_cidr: 172.18.0.0/21
      subnets:
        - name: wtvpc-webapptier-us-south-1
          ipv4_cidr_block: 172.18.0.0/24
          network_acl: wtvpc-webapptier-acl
          publicGateway: true
          instances:
            - name: webapp%02d
              quantity: 1
              template: webapp_server
              floating_ip: false
              security_group: wtvpc-webapptier-sg
              in_lb_pool:
                - lb_name: wtvpc-webapptier-lb
                  lb_pool: nginx-http
                  listen_port: 80
        - name: wtvpc-dbtier-us-south-1
          ipv4_cidr_block: 172.18.1.0/24
          network_acl: wtvpc-dbtier-acl
          publicGateway: true
          instances:
            - name: db%02d
              quantity: 1
              template: db_server
              floating_ip: false
              security_group: wtvpc-dbtier-sg
        - name: wtvpc-vpntier-us-south-1
          ipv4_cidr_block: 172.18.2.0/24
          network_acl: wtvpc-vpntier-acl
          publicGateway: true
          vpn:
            - name: wtvpc-vpn-us-south-1
              connections:
                - name: on-prem-to-wtvpc-us-south-1
                  peer_address: 0.0.0.0
                  preshared_key: vpnpassword
                  peer_cidrs:
                    - 192.168.248.0/24
    - name: us-south-2
      address_prefix_cidr: 172.18.8.0/21
      subnets:
        - name: wtvpc-webapptier-us-south-2
          ipv4_cidr_block: 172.18.8.0/24
          publicGateway: true
          network_acl: wtvpc-webapptier-acl
          instances:
            - name: webapp%02d
              quantity: 1
              template: webapp_server
              floating_ip: false
              security_group: wtvpc-webapptier-sg
              in_lb_pool:
                - lb_name: wtvpc-webapptier-lb
                  lb_pool: nginx-http
                  listen_port: 80
        - name: wtvpc-dbtier-us-south-2
          ipv4_cidr_block: 172.18.9.0/24
          network_acl: wtvpc-dbtier-acl
          publicGateway: true
          instances:
            - name: db%02d
              quantity: 1
              template: db_server
              floating_ip: false
              security_group: wtvpc-dbtier-sg
        - name: wtvpc-vpntier-us-south-2
          ipv4_cidr_block: 172.18.10.0/24
          network_acl: wtvpc-vpntier-acl
          publicGateway: true
          vpn:
            - name: wtvpc-vpn-us-south-2
              connections:
                - name: on-prem-to-wtvpc-us-south-2
                  peer_address: 0.0.0.0
                  preshared_key: vpnpassword
                  peer_cidrs:
                    - 192.168.248.0/24
  load_balancers:
    - lbInstance: wtvpc-webapptier-lb
      is_public: true
      subnets:
        - wtvpc-webapptier-us-south-1
        - wtvpc-webapptier-us-south-2
      listeners:
        - protocol: http
          port: 80
          connection_limit: 1000
          default_pool_name: nginx-http
      pools:
        - name: nginx-http
          protocol: http
          algorithm: round_robin
          health_monitor:
            type: http
            delay: 5
            max_retries: 2
            timeout: 2
            url_path: /readme.html
  security_groups:
    - security_group: wtvpc-webapptier-sg
      rules:
        - direction: inbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 172.18.0.0/24
        - direction: inbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 172.18.8.0/24
        - direction: inbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 192.168.248.0/24
        - direction: outbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 0.0.0.0/0
    - security_group: wtvpc-dbtier-sg
      rules:
        - direction: inbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 172.18.1.0/24
        - direction: inbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 172.18.9.0/24
        - direction: inbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 192.168.248.0/24
        - direction: inbound
          ip_version: ipv4
          port_min: 3306
          port_max: 3306
          protocol: tcp
          remote:
            security_group: wtvpc-webapptier-sg
        - direction: outbound
          ip_version: ipv4
          protocol: all
          remote:
            cidr_block: 0.0.0.0/0
  network_acls:
    - network_acl: wtvpc-default-acl
      rules:
        - name: deny-inbound-all
          direction: inbound
          action: deny
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
        - name: deny-outbound-all
          direction: outbound
          action: deny
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
    - network_acl: wtvpc-vpntier-acl
      rules:
        - name: allow-icmp
          direction: inbound
          action: allow
          protocol: icmp
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
        - name: allow-vpc
          direction: inbound
          action: allow
          source: 172.18.0.0/20
          destination: 0.0.0.0/0
        - name: allow-vpn-endpoint
          direction: inbound
          action: allow
          source: 24.252.30.9
          destination: 0.0.0.0/0
        - name: allow-remote-network
          direction: inbound
          action: allow
          source: 192.168.248.0/24
          destination: 0.0.0.0/0
        - name: allow-inbound-dest-tcp56500
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
          port_min: 56500
          port_max: 56500
        - name: allow-inbound-dest-tcp443
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
          port_min: 443
          port_max: 443
        - name: allow-inbound-tcp53
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          source_port_min: 53
          source_port_max: 53
          destination: 0.0.0.0/0
        - name: allow-inbound-udp53
          direction: inbound
          action: allow
          protocol: udp
          source: 0.0.0.0/0
          source_port_min: 53
          source_port_max: 53
          destination: 0.0.0.0/0
        - name: allow-inbound-tcp80
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          source_port_min: 80
          source_port_max: 80
          destination: 0.0.0.0/0
        - name: allow-inbound-tcp443
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          source_port_min: 443
          source_port_max: 443
          destination: 0.0.0.0/0
        - name: allow-inbound-tcp10514
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          source_port_min: 10514
          source_port_max: 10514
          destination: 0.0.0.0/0
        - name: allow-inbound-tcp9091
          direction: inbound
          action: allow
          protocol: tcp
          source: 0.0.0.0/0
          source_port_min: 9091
          source_port_max: 9091
          destination: 0.0.0.0/0
        - name: allow-outbound-all
          direction: outbound
          action: allow
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
    - network_acl: wtvpc-webapptier-acl
      rules:
        - name: home-ip
          direction: inbound
          action: allow
          source: 24.252.30.9
          destination: 0.0.0.0/0
        - name: icmp-all
          direction: inbound
          action: allow
          source: 0.0.0.0/0
          protocol: icmp
          destination: 0.0.0.0/0
        - name: udp-user-ports
          direction: inbound
          action: allow
          source: 0.0.0.0/0
          protocol: udp
          destination: 0.0.0.0/0
          port_min: 1024
          port_max: 65535
        - name: tcp-user-ports
          direction: inbound
          action: allow
          source: 0.0.0.0/0
          protocol: tcp
          destination: 0.0.0.0/0
          port_min: 1024
          port_max: 65535
        - name: from-vpn
          direction: inbound
          action: allow
          source: 192.168.248.0/24
          destination: 172.18.0.0/20
        - name: within-vpc
          direction: inbound
          action: allow
          source: 172.18.0.0/20
          destination: 172.18.0.0/20
        - name: web-http-in
          direction: inbound
          action: allow
          source: 0.0.0.0/0
          protocol: tcp
          destination: 172.18.0.0/20
          port_min: 80
          port_max: 80
        - name: allow-all-out
          direction: outbound
          action: allow
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
    - network_acl: wtvpc-dbtier-acl
      rules:
        - name: icmp-all
          direction: inbound
          action: allow
          protocol: icmp
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
        - name: udp-user-ports
          direction: inbound
          action: allow
          source: 0.0.0.0/0
          protocol: udp
          destination: 0.0.0.0/0
          port_min: 1024
          port_max: 65535
        - name: tcp-user-ports
          direction: inbound
          action: allow
          source: 0.0.0.0/0
          protocol: tcp
          destination: 0.0.0.0/0
          port_min: 1024
          port_max: 65535
        - name: from-remote-vpn
          direction: inbound
          action: allow
          source: 192.168.248.0/24
          destination: 172.18.0.0/20
        - name: inbound-within-vpc
          direction: inbound
          action: allow
          source: 172.18.0.0/20
          destination: 172.18.0.0/20
        - name: allow-all-out
          direction: outbound
          action: allow
          source: 0.0.0.0/0
          destination: 0.0.0.0/0
  sshkeys:
    - sshkey: jonhall
      public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDQ6H4W/5PCtVb6BEgbxNdgDbrJsAFD/Y13mz+qVhM6kHmoOBu5tbbQh7LGfCjpHzZ2A59m2i3zpFNwA9r06UErIfG8U020QAnirrmpo1qqB9tMI7BRSyvf5NFXnUklyszQSsXxxM6eYiQLiHDNnVN7Qyzgq5YcZ8eb559KzmyretdPulEBQvWKZyUbE03kX8ScNTI87p/jX/464viudryjtLgUNuJoFtCCYdoolvnNZsAq3wBl9LOgNaT33nP1ys1R4azG3pC921WX5+g4txws7tVzjPB/e5caOYdGXbFnYi2TXY3agX0wCNj/p/nPEO29c7s7kzEZN9o8ygSrj+Yn'
